<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فرم سابقه کاری</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="bg-primary text-white text-center py-3 rounded mb-4">
                    <h1><i class="bi bi-mic-fill me-2"></i>فرم سابقه کاری</h1>
                </div>
            </div>
        </div>

        <form action="/submit" method="POST" enctype="multipart/form-data">
            <!-- Question 1: Employment Status -->
            <div id="question1" class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4><i class="bi bi-briefcase me-2"></i>آیا شاغل هستید؟</h4>
                </div>
                <div class="card-body">
                    <!-- Input Method Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="textTab1" type="button" onclick="switchInputMethod(1, 'text')">
                                <i class="bi bi-keyboard me-1"></i>متنی
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="voiceTab1" type="button" onclick="switchInputMethod(1, 'voice')">
                                <i class="bi bi-mic me-1"></i>صوتی
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Text Input -->
                    <div id="textInput1" class="input-method">
                        <div class="mb-3">
                            <label class="form-label">پاسخ شما:</label>
                            <textarea class="form-control" name="answer_1" id="answer1" rows="3" placeholder="مثال: بله، شاغل هستم یا نه، شاغل نیستم"></textarea>
                        </div>
                    </div>
                    
                    <!-- Voice Input -->
                    <div id="voiceInput1" class="input-method" style="display: none;">
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-primary btn-lg" id="recordBtn1" onclick="toggleRecording(1)">
                                <i class="bi bi-mic-fill me-2"></i>
                                <span class="record-text">شروع ضبط</span>
                            </button>
                        </div>
                        <div id="recordingStatus1" style="display: none;" class="alert alert-danger text-center mb-3">
                            <i class="bi bi-record-circle-fill me-2"></i>
                            در حال ضبط... <span id="recordingTimer1">00:00</span>
                        </div>
                        <audio id="audioPreview1" class="w-100 mb-3" controls style="display: none;"></audio>
                        <input type="file" name="audio_1" id="audioFile1" accept="audio/*" style="display: none;">
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" id="confirmBtn1" onclick="processQuestion1()">
                            <i class="bi bi-check me-1"></i>ادامه
                        </button>
                        <span id="status1" class="badge bg-secondary ms-2" style="display: none;">تأیید شد</span>
                    </div>
                </div>
            </div>

            <!-- Question 2: Job Title -->
            <div id="question2" class="card mb-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h4><i class="bi bi-person-badge me-2"></i>شغل شما چیست؟</h4>
                </div>
                <div class="card-body">
                    <!-- Input Method Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="textTab2" type="button" onclick="switchInputMethod(2, 'text')">
                                <i class="bi bi-keyboard me-1"></i>متنی
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="voiceTab2" type="button" onclick="switchInputMethod(2, 'voice')">
                                <i class="bi bi-mic me-1"></i>صوتی
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Text Input -->
                    <div id="textInput2" class="input-method">
                        <div class="mb-3">
                            <label class="form-label">نام شغل:</label>
                            <textarea class="form-control" name="answer_2" id="answer2" rows="3" placeholder="مثال: مهندس، معلم، پزشک، فروشنده"></textarea>
                        </div>
                    </div>
                    
                    <!-- Voice Input -->
                    <div id="voiceInput2" class="input-method" style="display: none;">
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-primary btn-lg" id="recordBtn2" onclick="toggleRecording(2)">
                                <i class="bi bi-mic-fill me-2"></i>
                                <span class="record-text">شروع ضبط</span>
                            </button>
                        </div>
                        <div id="recordingStatus2" style="display: none;" class="alert alert-danger text-center mb-3">
                            <i class="bi bi-record-circle-fill me-2"></i>
                            در حال ضبط... <span id="recordingTimer2">00:00</span>
                        </div>
                        <audio id="audioPreview2" class="w-100 mb-3" controls style="display: none;"></audio>
                        <input type="file" name="audio_2" id="audioFile2" accept="audio/*" style="display: none;">
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" id="confirmBtn2" onclick="processQuestion2()" disabled>
                            <i class="bi bi-check me-1"></i>ادامه
                        </button>
                        <span id="status2" class="badge bg-secondary ms-2" style="display: none;">تأید شد</span>
                    </div>
                </div>
            </div>

            <!-- Question 3: Work Duration -->
            <div id="question3" class="card mb-4" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h4><i class="bi bi-calendar-range me-2"></i>از چه سنی و تا چه سنی مشغول به این کار هستید؟</h4>
                </div>
                <div class="card-body">
                    <!-- Input Method Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="textTab3" type="button" onclick="switchInputMethod(3, 'text')">
                                <i class="bi bi-keyboard me-1"></i>متنی
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="voiceTab3" type="button" onclick="switchInputMethod(3, 'voice')">
                                <i class="bi bi-mic me-1"></i>صوتی
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Text Input -->
                    <div id="textInput3" class="input-method">
                        <div class="mb-3">
                            <label class="form-label">بازه سنی کار:</label>
                            <textarea class="form-control" name="answer_3" id="answer3" rows="3" placeholder="مثال: از 25 سالگی تا الان، یا از 20 تا 30 سالگی"></textarea>
                        </div>
                    </div>
                    
                    <!-- Voice Input -->
                    <div id="voiceInput3" class="input-method" style="display: none;">
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-primary btn-lg" id="recordBtn3" onclick="toggleRecording(3)">
                                <i class="bi bi-mic-fill me-2"></i>
                                <span class="record-text">شروع ضبط</span>
                            </button>
                        </div>
                        <div id="recordingStatus3" style="display: none;" class="alert alert-danger text-center mb-3">
                            <i class="bi bi-record-circle-fill me-2"></i>
                            در حال ضبط... <span id="recordingTimer3">00:00</span>
                        </div>
                        <audio id="audioPreview3" class="w-100 mb-3" controls style="display: none;"></audio>
                        <input type="file" name="audio_3" id="audioFile3" accept="audio/*" style="display: none;">
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" id="confirmBtn3" onclick="processQuestion3()" disabled>
                            <i class="bi bi-check me-1"></i>اتمام
                        </button>
                        <span id="status3" class="badge bg-secondary ms-2" style="display: none;">تأید شد</span>
                    </div>
                </div>
            </div>

            <!-- Not Employed Message (Hidden initially) -->
            <div id="notEmployed" class="alert alert-info text-center" style="display: none;">
                <h5><i class="bi bi-info-circle me-2"></i>متشکریم!</h5>
                <p>از شما بابت پاسخ‌تان متشکریم. چون شاغل نیستید، سوالات بعدی مربوط به شما نمی‌شود.</p>
                <button type="button" class="btn btn-primary" onclick="enableSubmitForUnemployed()">
                    <i class="bi bi-check me-1"></i>اتمام نظرسنجی
                </button>
            </div>

            <!-- Submit Section (Hidden initially) -->
            <div id="submitSection" class="text-center" style="display: none;">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-send me-2"></i>ارسال نظرسنجی
                </button>
            </div>
            <!-- Hidden inputs to store processed data -->
            <input type="hidden" name="processed_data" id="processedData">
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recordingTimers = {};
        
        // Switch between text and voice input methods
        function switchInputMethod(questionNum, method) {
            const textInput = document.getElementById(`textInput${questionNum}`);
            const voiceInput = document.getElementById(`voiceInput${questionNum}`);
            const textTab = document.getElementById(`textTab${questionNum}`);
            const voiceTab = document.getElementById(`voiceTab${questionNum}`);
            
            if (method === 'text') {
                textInput.style.display = 'block';
                voiceInput.style.display = 'none';
                textTab.classList.add('active');
                voiceTab.classList.remove('active');
            } else {
                textInput.style.display = 'none';
                voiceInput.style.display = 'block';
                textTab.classList.remove('active');
                voiceTab.classList.add('active');
            }
        }
        
        // Toggle audio recording
        async function toggleRecording(questionNum) {
            const recordBtn = document.getElementById(`recordBtn${questionNum}`);
            const recordingStatus = document.getElementById(`recordingStatus${questionNum}`);
            const recordText = recordBtn.querySelector('.record-text');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                recordBtn.classList.remove('btn-danger');
                recordBtn.classList.add('btn-primary');
                recordText.textContent = 'شروع ضبط';
                recordingStatus.style.display = 'none';
                
                if (recordingTimers[questionNum]) {
                    clearInterval(recordingTimers[questionNum]);
                    delete recordingTimers[questionNum];
                }
            } else {
                // Start recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = function(event) {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = function() {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioFile = document.getElementById(`audioFile${questionNum}`);
                        const file = new File([audioBlob], `recording_${questionNum}.wav`, { type: 'audio/wav' });
                        
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        audioFile.files = dataTransfer.files;
                        
                        // Show audio preview
                        const audioPreview = document.getElementById(`audioPreview${questionNum}`);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPreview.src = audioUrl;
                        audioPreview.style.display = 'block';
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Enable confirm button
                        const confirmBtn = document.getElementById(`confirmBtn${questionNum}`);
                        if (confirmBtn) confirmBtn.disabled = false;
                    };
                    
                    mediaRecorder.start();
                    recordBtn.classList.remove('btn-primary');
                    recordBtn.classList.add('btn-danger');
                    recordText.textContent = 'توقف ضبط';
                    recordingStatus.style.display = 'block';
                    
                    // Start timer
                    let seconds = 0;
                    const timerElement = document.getElementById(`recordingTimer${questionNum}`);
                    recordingTimers[questionNum] = setInterval(() => {
                        seconds++;
                        const minutes = Math.floor(seconds / 60);
                        const remainingSeconds = seconds % 60;
                        timerElement.textContent = 
                            `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('خطا در دسترسی به میکروفون. لطفاً اجازه دسترسی را بدهید.');
                }
            }
        }
        
        async function processQuestion1() {
            const textAnswer = document.getElementById('answer1').value.trim();
            const audioFile = document.getElementById('audioFile1').files[0];
            
            if (!textAnswer && !audioFile) {
                alert('لطفاً به سوال پاسخ دهید (متنی یا صوتی)');
                return;
            }

            // Show loading state
            const confirmBtn = document.getElementById('confirmBtn1');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>در حال پردازش...';
            confirmBtn.disabled = true;
            
            try {
                // Send to Gemini for processing
                const formData = new FormData();
                formData.append('question_num', '1');
                formData.append('question_text', 'آیا شاغل هستید؟');
                
                if (textAnswer) {
                    formData.append('text_answer', textAnswer);
                }
                if (audioFile) {
                    formData.append('audio_file', audioFile);
                }
                
                const response = await fetch('/process_question', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store the processed data
                    window.question1Data = result;
                    
                    // Show processed result
                    showProcessedResult(1, result);
                    
                    // Mark question 1 as completed
                    confirmBtn.style.display = 'none';
                    document.getElementById('status1').style.display = 'inline-block';
                    
                    // Determine if employed based on Gemini's response
                    const isEmployed = result.structured_data && result.structured_data.has_job === true;
                    
                    if (isEmployed) {
                        // Show question 2 for employed
                        document.getElementById('question2').style.display = 'block';
                        // Enable question 2 button for text input
                        document.getElementById('answer2').addEventListener('input', function() {
                            const btn = document.getElementById('confirmBtn2');
                            btn.disabled = !this.value.trim();
                        });
                    } else {
                        // Show not employed message
                        document.getElementById('notEmployed').style.display = 'block';
                    }
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
                
            } catch (error) {
                console.error('Error processing question 1:', error);
                alert('خطا در پردازش پاسخ. لطفاً دوباره تلاش کنید.');
                
                // Restore button
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        async function processQuestion2() {
            const textAnswer = document.getElementById('answer2').value.trim();
            const audioFile = document.getElementById('audioFile2').files[0];
            
            if (!textAnswer && !audioFile) {
                alert('لطفاً نام شغل خود را وارد کنید');
                return;
            }
            
            // Show loading state
            const confirmBtn = document.getElementById('confirmBtn2');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>در حال پردازش...';
            confirmBtn.disabled = true;
            
            try {
                // Send to Gemini for processing
                const formData = new FormData();
                formData.append('question_num', '2');
                formData.append('question_text', 'شغل شما چیست؟');
                
                if (textAnswer) {
                    formData.append('text_answer', textAnswer);
                }
                if (audioFile) {
                    formData.append('audio_file', audioFile);
                }
                
                const response = await fetch('/process_question', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store the processed data
                    window.question2Data = result;
                    
                    // Show processed result
                    showProcessedResult(2, result);
                    
                    // Mark question 2 as completed
                    confirmBtn.style.display = 'none';
                    document.getElementById('status2').style.display = 'inline-block';
                    
                    document.getElementById('question3').style.display = 'block';
                    
                    // Enable question 3 button for text input
                    document.getElementById('answer3').addEventListener('input', function() {
                        const btn = document.getElementById('confirmBtn3');
                        btn.disabled = !this.value.trim();
                    });
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
                
            } catch (error) {
                console.error('Error processing question 2:', error);
                alert('خطا در پردازش پاسخ. لطفاً دوباره تلاش کنید.');
                
                // Restore button
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        async function processQuestion3() {
            const textAnswer = document.getElementById('answer3').value.trim();
            const audioFile = document.getElementById('audioFile3').files[0];
            
            if (!textAnswer && !audioFile) {
                alert('لطفاً بازه سنی کار خود را وارد کنید');
                return;
            }
            
            // Show loading state
            const confirmBtn = document.getElementById('confirmBtn3');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>در حال پردازش...';
            confirmBtn.disabled = true;
            
            try {
                // Send to Gemini for processing
                const formData = new FormData();
                formData.append('question_num', '3');
                formData.append('question_text', 'از چه سنی و تا چه سنی مشغول به این کار هستید؟');
                
                if (textAnswer) {
                    formData.append('text_answer', textAnswer);
                }
                if (audioFile) {
                    formData.append('audio_file', audioFile);
                }
                
                const response = await fetch('/process_question', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store the processed data
                    window.question3Data = result;
                    
                    // Show processed result (this handles validation errors internally)
                    showProcessedResult(3, result);
                    
                    // Only proceed if no validation errors
                    if (!result.needs_reentry) {
                        // Mark question 3 as completed
                        confirmBtn.style.display = 'none';
                        document.getElementById('status3').style.display = 'inline-block';
                        
                        // Show submit button
                        document.getElementById('submitSection').style.display = 'block';
                    }
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
                
            } catch (error) {
                console.error('Error processing question 3:', error);
                alert('خطا در پردازش پاسخ. لطفاً دوباره تلاش کنید.');
                
                // Restore button
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        // Function to display processed results
        function showProcessedResult(questionNum, result) {
            const questionCard = document.querySelector(`[data-question-num="${questionNum}"]`) || 
                                document.getElementById(`question${questionNum}`);
            
            if (!questionCard) return;
            
            // Remove any existing validation error displays first
            const existingError = questionCard.querySelector('.validation-error');
            if (existingError) {
                existingError.remove();
            }
            
            // Check for validation errors
            if (result.needs_reentry && result.validation_errors && result.validation_errors.length > 0) {
                // Show validation errors with re-record options
                showValidationError(questionNum, result.validation_errors);
                return; // Don't show processed result if there are validation errors
            }
            
            // Hide input sections and confirm button when showing results
            hideInputSections(questionNum);
            
            // Create or update result display
            let resultDiv = questionCard.querySelector('.processed-result');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.className = 'processed-result alert alert-success mt-3';
                questionCard.querySelector('.card-body').appendChild(resultDiv);
            }
            
            let html = '<h6><i class="bi bi-check-circle me-2"></i>نتیجه پردازش هوش مصنوعی:</h6>';
            
            if (result.transcription) {
                html += `<p><strong>متن ضبط شده:</strong> ${result.transcription}</p>`;
            }
            
            html += `<p><strong>پاسخ پردازش شده:</strong> ${result.processed_answer}</p>`;
            
            if (result.structured_data) {
                html += '<p><strong>داده‌های ساختاریافته:</strong></p><ul>';
                for (const [key, value] of Object.entries(result.structured_data)) {
                    if (value !== null && value !== undefined) {
                        html += `<li><code>${key}</code>: ${value}</li>`;
                    }
                }
                html += '</ul>';
            }
            
            // Add edit button
            html += `
                <div class="mt-3 text-center">
                    <button class="btn btn-outline-secondary btn-sm" onclick="editAnswer(${questionNum})">
                        <i class="bi bi-pencil-square me-1"></i>ویرایش پاسخ
                    </button>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }
        
        // Function to hide input sections when showing results
        function hideInputSections(questionNum) {
            const questionCard = document.getElementById(`question${questionNum}`);
            if (!questionCard) return;
            
            // Hide tabs
            const tabs = questionCard.querySelector('.nav-tabs');
            if (tabs) tabs.style.display = 'none';
            
            // Hide input methods
            const textInput = document.getElementById(`textInput${questionNum}`);
            const voiceInput = document.getElementById(`voiceInput${questionNum}`);
            if (textInput) textInput.style.display = 'none';
            if (voiceInput) voiceInput.style.display = 'none';
            
            // Hide confirm button and status
            const confirmBtn = document.getElementById(`confirmBtn${questionNum}`);
            const status = document.getElementById(`status${questionNum}`);
            if (confirmBtn) confirmBtn.style.display = 'none';
            if (status) status.style.display = 'none';
        }
        
        // Function to show input sections when editing
        function showInputSections(questionNum) {
            const questionCard = document.getElementById(`question${questionNum}`);
            if (!questionCard) return;
            
            // Show tabs
            const tabs = questionCard.querySelector('.nav-tabs');
            if (tabs) tabs.style.display = 'flex';
            
            // Show current input method (default to text)
            const textInput = document.getElementById(`textInput${questionNum}`);
            const voiceInput = document.getElementById(`voiceInput${questionNum}`);
            const textTab = document.getElementById(`textTab${questionNum}`);
            const voiceTab = document.getElementById(`voiceTab${questionNum}`);
            
            if (textInput && textTab) {
                textInput.style.display = 'block';
                voiceInput.style.display = 'none';
                textTab.classList.add('active');
                voiceTab.classList.remove('active');
            }
            
            // Show confirm button with correct text
            const confirmBtn = document.getElementById(`confirmBtn${questionNum}`);
            if (confirmBtn) {
                confirmBtn.style.display = 'inline-block';
                confirmBtn.disabled = false;
                
                // Set correct button text based on question number
                if (questionNum === 1 || questionNum === 2) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>ادامه';
                } else if (questionNum === 3) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>اتمام';
                }
            }
        }
        
        // Function to edit answer
        function editAnswer(questionNum) {
            const questionCard = document.getElementById(`question${questionNum}`);
            if (!questionCard) return;
            
            // Remove processed result display
            const resultDiv = questionCard.querySelector('.processed-result');
            if (resultDiv) {
                resultDiv.remove();
            }
            
            // Show input sections again
            showInputSections(questionNum);
            
            // Restore original confirm button text and onclick
            const confirmBtn = document.getElementById(`confirmBtn${questionNum}`);
            if (confirmBtn) {
                if (questionNum === 1) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>ادامه';
                    confirmBtn.onclick = () => processQuestion1();
                } else if (questionNum === 2) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>ادامه';
                    confirmBtn.onclick = () => processQuestion2();
                } else if (questionNum === 3) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>اتمام';
                    confirmBtn.onclick = () => processQuestion3();
                }
            }
            
            // Clear previous data
            if (questionNum === 1 && window.question1Data) {
                delete window.question1Data;
                // Hide subsequent questions when editing question 1
                document.getElementById('question2').style.display = 'none';
                document.getElementById('question3').style.display = 'none';
                document.getElementById('notEmployed').style.display = 'none';
                document.getElementById('submitSection').style.display = 'none';
            } else if (questionNum === 2 && window.question2Data) {
                delete window.question2Data;
                // Hide question 3 when editing question 2
                document.getElementById('question3').style.display = 'none';
                document.getElementById('submitSection').style.display = 'none';
            } else if (questionNum === 3 && window.question3Data) {
                delete window.question3Data;
                // Hide submit section when editing question 3
                document.getElementById('submitSection').style.display = 'none';
            }
            
            // Reset status indicators
            const status = document.getElementById(`status${questionNum}`);
            if (status) status.style.display = 'none';
            
            // Focus on text input
            const textAnswer = document.getElementById(`answer${questionNum}`);
            if (textAnswer) {
                textAnswer.focus();
            }
        }
        
        // Function to show validation errors with re-record options
        function showValidationError(questionNum, errors) {
            const questionCard = document.getElementById(`question${questionNum}`);
            if (!questionCard) return;
            
            // Create validation error display
            let errorDiv = questionCard.querySelector('.validation-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'validation-error alert alert-warning mt-3';
                questionCard.querySelector('.card-body').appendChild(errorDiv);
            }
            
            let html = '<h6><i class="bi bi-exclamation-triangle me-2"></i>خطا در پردازش:</h6>';
            
            errors.forEach(error => {
                html += `<p class="mb-2">• ${error}</p>`;
            });
            
            html += `
                <div class="mt-3">
                    <button class="btn btn-warning btn-sm" onclick="enableReEntry(${questionNum})">
                        <i class="bi bi-pencil me-1"></i>ویرایش پاسخ متنی
                    </button>
                    <button class="btn btn-danger btn-sm ms-2" onclick="enableReRecord(${questionNum})">
                        <i class="bi bi-mic me-1"></i>ضبط مجدد صوتی
                    </button>
                </div>
            `;
            
            errorDiv.innerHTML = html;
            
            // Reset confirm button with correct text
            const confirmBtn = document.getElementById(`confirmBtn${questionNum}`);
            if (confirmBtn) {
                confirmBtn.style.display = 'inline-block';
                confirmBtn.disabled = false;
                
                // Set correct button text based on question number
                if (questionNum === 1 || questionNum === 2) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>ادامه';
                } else if (questionNum === 3) {
                    confirmBtn.innerHTML = '<i class="bi bi-check me-1"></i>اتمام';
                }
            }
        }
        
        // Function to enable text re-entry
        function enableReEntry(questionNum) {
            // Remove validation error display
            const questionCard = document.getElementById(`question${questionNum}`);
            const errorDiv = questionCard.querySelector('.validation-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // Remove processed result display
            const resultDiv = questionCard.querySelector('.processed-result');
            if (resultDiv) {
                resultDiv.remove();
            }
            
            // Show input sections
            showInputSections(questionNum);
            
            // Switch to text input method
            switchInputMethod(questionNum, 'text');
            
            // Clear previous answer
            const textInput = document.getElementById(`answer${questionNum}`);
            if (textInput) {
                textInput.value = '';
                textInput.focus();
            }
        }
        
        // Function to enable voice re-recording
        function enableReRecord(questionNum) {
            // Remove validation error display
            const questionCard = document.getElementById(`question${questionNum}`);
            const errorDiv = questionCard.querySelector('.validation-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // Remove processed result display
            const resultDiv = questionCard.querySelector('.processed-result');
            if (resultDiv) {
                resultDiv.remove();
            }
            
            // Show input sections
            showInputSections(questionNum);
            
            // Switch to voice input method
            switchInputMethod(questionNum, 'voice');
            
            // Clear previous recording
            const audioFile = document.getElementById(`audioFile${questionNum}`);
            const audioPreview = document.getElementById(`audioPreview${questionNum}`);
            
            if (audioFile) {
                audioFile.value = '';
            }
            if (audioPreview) {
                audioPreview.style.display = 'none';
                audioPreview.src = '';
            }
            
            // Reset record button state
            const recordBtn = document.getElementById(`recordBtn${questionNum}`);
            if (recordBtn) {
                recordBtn.classList.remove('btn-danger');
                recordBtn.classList.add('btn-primary');
                recordBtn.querySelector('.record-text').textContent = 'شروع ضبط';
            }
        }
        
        // Function to enable submit for unemployed users
        function enableSubmitForUnemployed() {
            document.getElementById('submitSection').style.display = 'block';
        }
        
        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            form.addEventListener('submit', function() {
                // Collect all processed data
                const allProcessedData = {
                    question1: window.question1Data,
                    question2: window.question2Data,
                    question3: window.question3Data
                };
                
                // Store in hidden input
                document.getElementById('processedData').value = JSON.stringify(allProcessedData);
            });
        });
    </script>
</body>
</html>